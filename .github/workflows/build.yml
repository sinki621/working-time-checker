name: Build Portable OT Calculator

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Tesseract Engine on Server
      run: |
        # 초콜릿 패키지 매니저로 서버에 Tesseract 설치
        choco install tesseract --version 5.3.3 -y

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Prepare Engine for Bundling
      shell: pwsh
      run: |
        # 서버에 설치된 Tesseract 파일을 빌드 작업 폴더로 복사
        mkdir Tesseract-OCR
        xcopy "C:\Program Files\Tesseract-OCR\*" "Tesseract-OCR\" /E /H /Y
        # 저장소의 tessdata(언어 데이터)를 엔진 폴더 내로 강제 복사
        if (Test-Path "tessdata") {
            xcopy "tessdata\*" "Tesseract-OCR\tessdata\" /E /H /Y
        }

    - name: Build Single EXE
      run: |
        # --add-data 옵션으로 엔진 폴더 자체를 EXE 내부 리소스로 포함
        pyinstaller --noconfirm --onefile --windowed --add-data "Tesseract-OCR;Tesseract-OCR" --name "OTCalculator" main.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OTCalculator_Ready_To_Run
        path: dist/OTCalculator.exe
